FROM ruby:3.2.0-alpine AS builder

ENV APP_PATH=/lostpet101 \
    TMP_PATH=/tmp/ \
    BUNDLER_VERSION=2.4.5

RUN apk update && apk upgrade && \
    apk add --no-cache \
    build-base \
    git \
    bash \
    curl \
    postgresql-dev \
    imagemagick \
    tzdata && \
    rm -rf /var/cache/apk/*

RUN gem install bundler -v $BUNDLER_VERSION && \
    rm -rf /usr/local/bundle/cache

WORKDIR $APP_PATH

COPY Gemfile Gemfile.lock ./

RUN bundle install --without development test --jobs 4 --retry 3

FROM ruby:3.2.0-alpine

ENV APP_PATH=/lostpet101 \
    RAILS_ENV=production \
    RAILS_PORT=3000 \
    RAILS_LOG_TO_STDOUT=true

RUN apk add --no-cache \
    bash \
    curl \
    postgresql-client \
    imagemagick \
    tzdata && \
    rm -rf /var/cache/apk/*

WORKDIR $APP_PATH

COPY --from=builder /usr/local/bundle /usr/local/bundle
COPY . $APP_PATH

COPY script/entrypoint.sh /usr/bin/entrypoint.sh
RUN chmod +x /usr/bin/entrypoint.sh

EXPOSE $RAILS_PORT

ENTRYPOINT ["entrypoint.sh"]
CMD ["rails", "server", "-p", "3000", "-b", "0.0.0.0"]
